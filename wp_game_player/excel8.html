<?
header("Content-type: application/vnd.ms-excel");
header("Content-Disposition: attachment; filename=종목별/시군별총계표.xls");
header("Content-Description: PHP4 Generated Data");

// Session 시작 //
session_start();

// Mysql 클래스 //
require_once "../wp_library/mysql_class.php";

// DB 생성 //
$Mysql = new Mysql;
// DB 연결 //
$Mysql->Connect();

// Setup 설정 //
require_once "../wp_library/setup.php";

// Paging 클래스 //
require_once "../wp_library/page_class.php";

// Error 함수 //
require_once "../wp_library/check.php";
?>
<!--link type="text/css" rel="stylesheet" href="../wp_config/style.css"-->
<body>
<?
	if(!$s_gam_uid) $s_gam_uid = $gam_uid;
	$where = " WHERE gam_uid = '$s_gam_uid'";
	//검색조건
	//if($spo_code) $where .= " AND spo_code = '$spo_code'";
	if($spo_code && $spo_code != "AS100" && $spo_code !="AS200")
	{
		$where .= " AND spo_code = '$spo_code'";
	}
	else
	{
		//$where .= " AND spo_sec_code = '$spo_code'";
	}

	if($spo_code == "LAWNBOWIS" || $spo_code == "SHUFFLEBOARD" || $spo_code == "CUROLLING" || $spo_code == "TARGET" || $spo_code == "HANDLER")
	{
		$query = "SELECT distinct spo_code, spo_sec_code, tro_code, tro_level_code, sex FROM wp_game_event $where ORDER BY spo_code ASC, spo_sec_code ASC, tro_level_code ASC, sex ASC, spo_code_detail ASC";
	}
	else
	{
		$query = "SELECT * FROM wp_game_event $where ORDER BY spo_code ASC, spo_sec_code ASC, tro_level_code ASC, sex ASC, spo_code_detail ASC";
	}

	//echo $query;
	$result = mysql_query($query);
	//echo mysql_num_rows($result);
?>

	<table border="0" cellpadding="0" cellspacing="0">
	<tr>
		<td>
			<table border="0" cellpadding="0" cellspacing="0">
			<tr>
				<td colspan= "12" height="50" align="center"><font size="4"><b><?=$wp_games[$s_gam_uid]?> 참가자 [종목별/시군별 총계표]</b></font></td>
			</tr>
			</table>
			<table width="600px" border="1" cellpadding="0" cellspacing="0" style="font-size:0.8em">
			<tr align="center">
				<td width="30px"><b>종목</b></td>
				<td width="30px"><b>유형</b></td>
				<td width="30px"><b>등급</b></td>
				<td width="30px"><b>성별</b></td>
				<?
				if($spo_code != "LAWNBOWIS" && $spo_code != "SHUFFLEBOARD" && $spo_code != "CUROLLING" && $spo_code != "TARGET" && $spo_code != "HANDLER")
				{
				?>
				<td height="35"><b>세부</b></td>
				<?
				}
				?>
				<td align="center"><b>시도</b></td>
				<td align="center">총원</td>
				<td align="center"><b>이벤트</b></td>
				<?
				foreach($wp_club_code as $keys => $vals){
					if($keys == "jnsad" || $keys == "WEBPLUS") continue;
					echo "<td width='30'>".substr($vals,0,4)."</td>";
					if($prt_name == "1") echo "<td width='30px'>이름</td>";
				}
				?>
			</tr>
			<?
			while($obj = mysql_fetch_object($result)){
				$my_spo_code = $wp_game_code[$obj->spo_code];
				if($wp_sports_code[$obj->spo_code] != getSpo_sec_code($obj->spo_code,$obj->spo_sec_code)){
					$my_spo_code .= getSpo_sec_code($obj->spo_code,$obj->spo_sec_code);
				}

				$my_tro_code = substr($wp_trouble_code[$obj->tro_code],0,4);
				$my_tro_level_code = getTrouble_level_code($obj->spo_code, $obj->tro_level_code)."[$obj->tro_level_code] ";
				$my_sex = $wp_sex_code[$obj->sex]." ";
				$my_detail_code = $wp_sports_detail_code[$obj->spo_code_detail];
				if($spo_code == "LAWNBOWIS" || $spo_code == "SHUFFLEBOARD" || $spo_code == "CUROLLING" || $spo_code == "TARGET" || $spo_code == "HANDLER")
				{
					$a_que = "SELECT clu_code,group_concat(pla_name order by pla_name asc separator ',') pla_names,count(*) cnt FROM wp_game_player WHERE gam_uid = '$s_gam_uid' AND kubun='9' AND spo_code='$obj->spo_code' AND tro_code='$obj->tro_code' AND tro_level_code='$obj->tro_level_code' AND sex = '$obj->sex' GROUP BY clu_code";
				}
				else
				{
					$a_que = "SELECT clu_code,group_concat(pla_name order by pla_name asc separator ',') pla_names,count(*) cnt FROM wp_game_player WHERE gam_uid = '$s_gam_uid' AND kubun='9' AND spo_code='$obj->spo_code' AND tro_code='$obj->tro_code' AND tro_level_code='$obj->tro_level_code' AND sex = '$obj->sex' AND spo_code_detail='$obj->spo_code_detail' GROUP BY clu_code";
				}
				//echo $a_que;  AND spo_sec_code='$obj->spo_sec_code' 2차 종목 삭제 함 2017.04.20

				$a_res = mysql_query($a_que);
				$club_cnt_arr = array();
				$tot_cnt = 0;
				$pla_name_arr = array();
				while($a_obj = mysql_fetch_object($a_res))
				{
					$club_cnt_arr[$a_obj->clu_code] = $a_obj->cnt;
					$pla_name_arr[$a_obj->clu_code] = $a_obj->pla_names;
					$tot_cnt += $a_obj->cnt;
				}
				unset($my_add);
				//3개시군 이상 참여면 성립
				if(count($club_cnt_arr) >=3) $my_add = "성립";
				if($spo_code != "LAWNBOWIS" && $spo_code != "SHUFFLEBOARD" && $spo_code != "CUROLLING" && $spo_code != "TARGET" && $spo_code != "HANDLER")
				{
					$not_dist = "<td nowrap>$my_detail_code</td>";
				}
				else
				{
					$not_dist = "";
				}
			echo "
				<tr>
					<td align='center'>$my_spo_code</td>
					<td>$my_tro_code</td>
					<td nowrap>$my_tro_level_code</td>
					<td align='center'>$my_sex</td>
					$not_dist
					<td align='center'>".count($club_cnt_arr)."</td>
					<td align='center'>$tot_cnt</td>
					<td>$my_add</td>
				";
				foreach($wp_club_code as $keys => $vals)
				{
					if($keys == "jnsad" || $keys == "WEBPLUS") continue;
					echo "<td align='center' width='20px'>".$club_cnt_arr[$keys]."</td>";
					if($prt_name == "1") echo "<td nowrap>".$pla_name_arr[$keys]."</td>";
				}
			echo "</tr>";
			 }
			 ?>
			</table>
		</td>
	</tr>
	</table>
</body>
</html>