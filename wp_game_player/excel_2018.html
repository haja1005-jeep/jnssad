<?
// Session 시작 //
session_start();

// Mysql 클래스 //
require_once "../wp_library/mysql_class.php";
// DB 생성 //
$Mysql = new Mysql;
// DB 연결 //
$Mysql->Connect();

// Setup 설정 //
require_once "../wp_library/setup.php";

// Paging 클래스 //
require_once "../wp_library/page_class.php";

// Error 함수 //
require_once "../wp_library/check.php";




if(!$s_gam_uid) $s_gam_uid = $gam_uid;
?>

<form name="sForm" action="index.html?mode=list#list" method="post" onSubmit="return validate(this)">
<input type="hidden" name="gam_uid" value="<?=$s_gam_uid?>">
<!-- 선수 검색 시작 -->
<a name="list">
<table class="table-global">


<tr>
	<td>
		<!-- 선수검색 끝 -->
		<table class="tbList-a" >
		<tbody>
		<tr>
			<th width="3%">번호</th>
			<th width="5%">시/군</th>
			<th width="3%">구분</th>
			<th width="5%">선수명</th>
			<th width="3%">성별</th>
			<th width="5%">주민번호</th>

			<th width="5%">참가종목</th>
			<th width="5%">2차종목</th>
			<th width="5%">세부종목1</th>
			<th width="5%">세부종목2</th>
			<th width="5%">세부종목3</th>
			<th width="5%">세부종목4</th>
			<th width="5%">세부종목5</th>
			<th width="5%">세부종목6</th>
			<th width="5%">세부종목7</th>
			<th width="5%">세부종목8</th>
			<th width="5%">세부종목9</th>
			<th width="5%">장애유형</th>
			<th width="5%">스포츠등급</th>
			<th width="5%">장애등급</th>
			<th width="5%">전화번호</th>
			<th>주소</th>
		</tr>
		<?

		//ORDER BY절 생성
		if($orderby1 == "name") $orderby1 = "pla_name";
		if($orderby2 == "name") $orderby2 = "pla_name";
		if($orderby3 == "name") $orderby3 = "pla_name";
		if($orderby4 == "name") $orderby4 = "pla_name";
		
		//출력순
		if(!$orderby1 && !$orderby2 && !$orderby3 && !$orderby4)
			$orderby .= " clu_code ASC, kubun ASC, spo_code ASC, spo_sec_code ASC, spo_code_detail ASC, pla_name ASC,tro_code ASC, tro_level_code ASC,";
		if($orderby1)
			$orderby .= " $orderby1 ASC, ";
		if($orderby2)
			$orderby .= " $orderby2 ASC, ";
		if($orderby3)
			$orderby .= " $orderby3 ASC, ";
		if($orderby4)
			$orderby .= " $orderby4 ASC, ";
		$orderby .= " uid desc ";

		//해당 시/군의 데이터만 확인가능
		//WHERE절 생성 //
		if($Admin_auth == "top" || $Admin_auth == "s_group"){
			$where = " WHERE gam_uid = '$s_gam_uid'";
		} else{
			$where = " WHERE gam_uid = '$s_gam_uid'";
			$clu_code = $Admin_code;
		}


		//시/군이 있으면
		if($clu_code) $where .= " AND clu_code = '$clu_code'";
		if($clu_code == "testsad") $where = str_replace(" AND clu_code = '$clu_code'","",$where);

		//경기종목가있으면
		if($spo_code) $where .= " AND spo_code = '$spo_code' ";
		

		
		//선수구분
		if($kubun) $where .= " AND kubun= '$kubun' ";
		
		//장애유형 가있으면
		if($tro_code) $where .= " AND tro_code = '$tro_code' ";
		
		//장애세부유형 가있으면
		if($tro_level_code) $where .= " AND tro_level_code = '$tro_level_code' ";
		
		//성별 가있으면
		if($sex) $where .= " AND sex = '$sex' ";
		
		//경기세부종목가있으면
		if($spo_code_detail) $where .= " AND spo_code_detail = '$spo_code_detail' ";





		if(eregi("[^[:space:]]+",$key))
			$Q_key = " AND  $keyfield LIKE '%$key%' ";
		$where .= $Q_key;

		// 레코드 쿼리 //
		$query = "SELECT *, (SELECT sex p_sex FROM wp_player_ctrl WHERE wp_id = wgp.pla_id) p_sex,
						(SELECT concat(jumin1,'-',jumin2) jumin FROM wp_player_ctrl WHERE wp_id = wgp.pla_id) jumin,
                        (SELECT trouble_level my_level FROM wp_player_ctrl WHERE wp_id = wgp.pla_id) my_level,
                        (SELECT concat(hp1,'-',hp2,'-',hp3) my_tel FROM wp_player_ctrl WHERE wp_id = wgp.pla_id) my_tel,
                        (SELECT zip1 zip1 FROM wp_player_ctrl WHERE wp_id = wgp.pla_id) zip1,
                        (SELECT zip2 zip2 FROM wp_player_ctrl WHERE wp_id = wgp.pla_id) zip2,
                        (SELECT address1 address1 FROM wp_player_ctrl WHERE wp_id = wgp.pla_id) address1,
                        (SELECT address2 address2 FROM wp_player_ctrl WHERE wp_id = wgp.pla_id) address2,
						group_concat(spo_sec_code order by spo_sec_code asc separator '|') spo_sec_code,
                        group_concat(tro_level_code order by spo_code_detail asc separator '|') tro_level_codes,
						group_concat(spo_code_detail order by spo_code_detail asc separator '|') spo_code_details,
						group_concat(uid order by spo_code_detail asc separator '|') pla_uids				 
				   FROM wp_game_player wgp
				 $where GROUP BY pla_id,spo_code ORDER BY $orderby";
		$result = mysql_query($query);



		if(!$result)
		{
			Error("QUERY_ERROR");
			exit;
		}

		// 총 레코드 수 //
		$total_record = mysql_num_rows($result);

		// 일련 번호 //
		$article_num = $total_record;		

		echo $total_record;

		// 레코드 결과 //
		while($obj = mysql_fetch_object($result)){


			$my_pla_name = $obj->pla_name;
			
			// 검색단어 처리 //
			if(!strcmp($keyfield,"pla_name") && $key)
			{
				$my_pla_name = eregi_replace("($key)", "<font color='#FF0000'>\\1</font>", $my_pla_name);
			}


						//장애등급
						if($obj->trouble_level)
							$my_level = $obj->trouble_level."급";
						else $my_level = "";
                        
						//전화번호
						unset($my_tel);
						if($obj->hp1) $my_tel = $obj->hp1."-".$obj->hp2."-".$obj->hp3;
						else if($obj->hp1) $my_tel = $obj->tel1."-".$obj->teel2."-".$obj->tel3;

			if($obj->tro_level_code)
				$my_trouble_code = getTrouble_level_code($obj->spo_code, $obj->tro_level_code)."(".$obj->tro_level_code.")";
			else $my_trouble_code = "";

		?>

		<tr <?=$bgcolor?>>
			<td align="center"><?=$article_num?></td>
			<td align="center"><?=$wp_club_code[$obj->clu_code]?></td>
			<td align="center"><?=$wp_kubun_code[$obj->kubun]?></td>
			<td align="center"><?=$my_pla_name?></td>
			<td align="center"><?=$wp_sex_code[$obj->p_sex]?></td>
			<td align="center">
				<?
				if($Admin_auth == "top")
				{
					echo $obj->jumin;
				}
				else
				{
					$my_jumin_arr = explode("-",$obj->jumin);
					$my_ju = substr($my_jumin_arr[1],0,1);
					echo $my_jumin_arr[0]."-".$my_ju."******";
				}
				?>
			</td>

			<td align='center'>
			<?
			        echo $wp_sports_code[$obj->spo_code];
					
            ?>
			</td>

			<td align='center'>
			<?
                if($obj->spo_code == "POWERLIFTING")

					{

						if($obj->spo_sec_code == "PL100|PL200|PL300")
						{
							echo "벤치프레스종합";
						}
						else
						{
							echo "파워리프트종합";
						}

                    }

                if($obj->spo_code == "ATHIETICS")
					{

	                    $sec  = explode("|",$obj->spo_sec_code); //넘어는 값이 AS100|AS100|AS100
						
						if($sec[0] == "AS100")
						{
							echo "트랙";
						}
						else if($sec[0] == "AS200")
						{
							echo "필드";
						}

                    }
					
            ?>
			</td>
	
		
				<?
				$ii = "";
				$ll = 1;

				if($obj->kubun == $wp_kubun_선수){

					
					$sec  = explode("|",$obj->spo_sec_code);					
					$scd  = explode("|",$obj->spo_code_details);
					$uids = explode("|",$obj->pla_uids);
					$tlc  = explode("|",$obj->tro_level_codes);
								

					$ii = count($scd);
					$lastdot = "</td>";

					$tdcnt = 9 - $ii;

					foreach($scd as $keys => $vals){

					echo 	"<td align='left'>";
							
							$p_uid = $uids[$keys];

							if($ii == $ll) $lastdot = " ";
			
                            if($obj->spo_code == "POWERLIFTING") {

						            if($wp_sports_code[$obj->spo_code] != getSpo_sec_code($obj->spo_code,$obj->spo_sec_code))
						             {
							          echo " ".getSpo_sec_code($obj->spo_code,$sec[$ll-1])." ";
						             }

							  
				              }
                            
						   //세부종목
						   $wp_detail_code = $wp_sports_detail_code[$vals];
						   
						   
						   if($obj->spo_code == "ATHIETICS")
					       {

						       if($sec[0] == "AS100")
						         {
							       $wp_detail_code = str_replace("트랙", "", $wp_detail_code);
						         }
						       else if($sec[0] == "AS200")
						         {
							       $wp_detail_code = str_replace("필드", "", $wp_detail_code);
                                 }
						    }

    						echo "<span class='color02'>".$wp_detail_code."</span> {$lastdot} ";
								
							$ll++;
						}


		            for($i=0;$i<$tdcnt;$i++)
		             {				 
					  echo "<td></td>";
					 }
				
				
				} else {

                      echo "<td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>";
				}
				?>
		

		    <td align="center"><?=$wp_trouble_code[$obj->tro_code]?></td>
			<td align="center"><? if($my_trouble_code) echo "$my_trouble_code";?></td>
			
			<td align="center"><?=$obj->my_level?>급</td>
			<td align="center"><?=$obj->my_tel?></td>
			<td align="center">(<?=$obj->zip1?>-<?=$obj->zip2?>) <?=$obj->address1?> <?=$obj->address2?></td>
				
			
		</tr>
		<?
			$article_num--;
		} //while
		?>
		</tbody>
		</table>
	</td>
</tr>

</table>
