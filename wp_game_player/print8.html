<?php
/**
 * add by hsjang
 */
// Session 시작 //
session_start();

// Mysql 클래스 //
require_once "../wp_library/mysql_class.php";

// DB 생성 //
$Mysql = new Mysql;

// DB 연결 //
$Mysql->Connect();

// Setup 설정 //
require_once "../wp_library/setup.php";

// Error 함수 //
require_once "../wp_library/check.php";

// 대회번호 체크 //
if(!$s_gam_uid) $s_gam_uid = $gam_uid;

$where = " WHERE gam_uid = '$s_gam_uid'";
//검색조건
//if($spo_code) $where .= " AND spo_code = '$spo_code'";
if($spo_code && $spo_code != "AS100" && $spo_code !="AS200")
{
	$where .= " AND spo_code = '$spo_code'";
}
else
{
	//$where .= " AND spo_sec_code = '$spo_code'";
}

if($spo_code == "LAWNBOWIS" || $spo_code == "SHUFFLEBOARD" || $spo_code == "CUROLLING" || $spo_code == "TARGET" || $spo_code == "HANDLER")
{
	$query = "SELECT distinct spo_code, spo_sec_code, tro_code, tro_level_code, sex FROM wp_game_event $where ORDER BY spo_code ASC, spo_sec_code ASC, tro_level_code ASC, sex ASC, spo_code_detail ASC";
}
else
{
	$query = "SELECT * FROM wp_game_event $where ORDER BY spo_code ASC, spo_sec_code ASC, tro_level_code ASC, sex ASC, spo_code_detail ASC";
}

//echo $query;
$result = mysql_query($query);
//echo mysql_num_rows($result);
?>
<form name="sForm" id="sForm" method="post" onSubmit="return validate(this)">
<table class="table-global">
<tr>
	<td>
		<!-- 선수 검색 시작 -->
		<table class="tbSearch-c">
		<tr>
			<th width="10%">대회선택</th>
			<td>
				<select name="s_gam_uid" tabindex="1" hname="대회선택" required>
					<option value="">--선택-- </option>
					<?
						foreach($wp_games as $keys => $values){
							if($keys == $gam_uid)
								$is_selected = " selected";
							else $is_selected = "";
							echo "<option value='$keys' $is_selected>$values</option>";
						}
					?>
				</select>
				<select name="spo_code" tabindex="2" hname="경기종목" required> <!--Sports_Sec_Code(this.form,1);Sports_Detail3(this.form,1)">-->
					<option value=''>--경기종목--</option>
					<?
					foreach($wp_sports_code as $keys => $values){
						if($keys == $spo_code)
							$is_selected = " selected ";
						else $is_selected = "";
						//echo "<option value='$keys' $is_selected>$values</option>";
						if($keys == "ATHIETICS" )
						{
							echo "<option value='$keys' $is_selected>$values - 전체</option>";
							echo "<option value='AS100' $is_selected>$values - 트랙</option>";
							echo "<option value='AS200' $is_selected>$values - 필드</option>";
						}
						else
						{
							echo "<option value='$keys' $is_selected>$values</option>";
						}
					}
					?>
				</select>
				<?
				if($Admin_auth == "top") echo " | <input type='checkbox' name='prt_name' value='1'>이름출력";
				?>
				<input type="button" tabindex="4" value="미리보기" data-btn="preview" class="btnBox3">
				<input type="button" tabindex="5" value="종목별/시군별총계표 출력" data-btn="excel" class="btnBox3">
			</td>
		</tr>
		</table>
	</td>
</tr>
</table>
</form>

<script type="text/javascript">
  $(function() {
    var fObj = $('#sForm');
    $('[data-btn="preview"]').click(function() {
      fObj.attr('action', location.href);
      fObj.submit();
    });

    $('[data-btn="excel"]').click(function() {
      fObj.attr('action', './<?= str_replace('print', 'excel', $mode) ?>.html');
      fObj.submit();
    });
  });
</script>

<link rel="stylesheet" href="wp_game_player.css">
<table class="table-type01">
	<thead>
		<tr>
			<th>종목</th>
			<th>유형</th>
			<th>등급</th>
			<th>성별</th>
			<?
			if($spo_code != "LAWNBOWIS" && $spo_code != "SHUFFLEBOARD" && $spo_code != "CUROLLING" && $spo_code != "TARGET" && $spo_code != "HANDLER")
			{
			?>
			<th>세부</th>
			<?
			}
			?>
			<th>시도</th>
			<th>총원</th>
			<th>이벤트</th>
			<?
			foreach($wp_club_code as $keys => $vals){
				if($keys == "jnsad" || $keys == "WEBPLUS") continue;
				echo "<th>".substr($vals,0,4)."</th>";
				if($prt_name == "1") echo "<th>이름</th>";
			}
			?>
		</tr>
	</thead>
	<tbody>
		<?
		while($obj = mysql_fetch_object($result)){
			$my_spo_code = $wp_game_code[$obj->spo_code];
			if($wp_sports_code[$obj->spo_code] != getSpo_sec_code($obj->spo_code,$obj->spo_sec_code)){
				$my_spo_code .= getSpo_sec_code($obj->spo_code,$obj->spo_sec_code);
			}

			$my_tro_code = substr($wp_trouble_code[$obj->tro_code],0,4);
			$my_tro_level_code = getTrouble_level_code($obj->spo_code, $obj->tro_level_code)."[$obj->tro_level_code] ";
			$my_sex = $wp_sex_code[$obj->sex]." ";
			$my_detail_code = $wp_sports_detail_code[$obj->spo_code_detail];
			if($spo_code == "LAWNBOWIS" || $spo_code == "SHUFFLEBOARD" || $spo_code == "CUROLLING" || $spo_code == "TARGET" || $spo_code == "HANDLER")
			{
				$a_que = "SELECT clu_code,group_concat(pla_name order by pla_name asc separator ',') pla_names,count(*) cnt FROM wp_game_player WHERE gam_uid = '$s_gam_uid' AND kubun='9' AND spo_code='$obj->spo_code' AND tro_code='$obj->tro_code' AND tro_level_code='$obj->tro_level_code' AND sex = '$obj->sex' GROUP BY clu_code";
			}
			else
			{
				$a_que = "SELECT clu_code,group_concat(pla_name order by pla_name asc separator ',') pla_names,count(*) cnt FROM wp_game_player WHERE gam_uid = '$s_gam_uid' AND kubun='9' AND spo_code='$obj->spo_code' AND tro_code='$obj->tro_code' AND tro_level_code='$obj->tro_level_code' AND sex = '$obj->sex' AND spo_code_detail='$obj->spo_code_detail' GROUP BY clu_code";
			}
			//echo $a_que;  AND spo_sec_code='$obj->spo_sec_code' 2차 종목 삭제 함 2017.04.20

			$a_res = mysql_query($a_que);
			$club_cnt_arr = array();
			$tot_cnt = 0;
			$pla_name_arr = array();
			while($a_obj = mysql_fetch_object($a_res))
			{
				$club_cnt_arr[$a_obj->clu_code] = $a_obj->cnt;
				$pla_name_arr[$a_obj->clu_code] = $a_obj->pla_names;
				$tot_cnt += $a_obj->cnt;
			}
			unset($my_add);
			//3개시군 이상 참여면 성립
			if(count($club_cnt_arr) >=3) $my_add = "성립";
			if($spo_code != "LAWNBOWIS" && $spo_code != "SHUFFLEBOARD" && $spo_code != "CUROLLING" && $spo_code != "TARGET" && $spo_code != "HANDLER")
			{
				$not_dist = "<td nowrap>$my_detail_code</td>";
			}
			else
			{
				$not_dist = "";
			}
		echo "
			<tr>
				<td>$my_spo_code</td>
				<td>$my_tro_code</td>
				<td nowrap>$my_tro_level_code</td>
				<td>$my_sex</td>
				$not_dist
				<td>".count($club_cnt_arr)."</td>
				<td>$tot_cnt</td>
				<td>$my_add</td>
			";
			foreach($wp_club_code as $keys => $vals)
			{
				if($keys == "jnsad" || $keys == "WEBPLUS") continue;
				echo "<td>".$club_cnt_arr[$keys]."</td>";
				if($prt_name == "1") echo "<td nowrap>".$pla_name_arr[$keys]."</td>";
			}
		echo "</tr>";
		 }
		 ?>
	</tbody>
</table>
