<script language=javascript>

$(document).ready( function(e) {

    var fObj = $('#sForm');
    $('[data-btn="preview"]').click(function() {
        fObj.attr('action', location.href);
        fObj.submit();
    });

    $('[data-btn="excel"]').click(function() {
        fObj.attr('action', './<?= str_replace('print', 'excel', $mode) ?>.html');
        fObj.submit();
    });

    $( "#spo_codeSel" ).change(function () {
        var str = "";
        $( "#spo_codeSel option:selected" ).each(function() {
        str += $( this ).text() + " ";
        });
        $( "#spo_code_name").val(str);
    });
});
</script>


<form name="sForm" id="sForm" method="post" onSubmit="return validate(this)">
<table class="table-global">
<tr>
	<td>
		<!-- 선수 검색 시작 -->
		<table class="tbSearch-c">
		<tr>
			<th width="10%">대회선택</th>
			<td>
				<select name="s_gam_uid" tabindex="1" hname="대회선택" required>
					<option value="">--선택-- </option>
					<?
						foreach($wp_games as $keys => $values){
							$is_selected = ($keys == $s_gam_uid) ? 'selected' : '';
							echo "<option value='$keys' $is_selected>$values</option>";
						}
					?>
				</select>
				<?
				// 경기단체(경기종목)//
				if($Admin_auth == "s_group")
				{
					$my_s_arr = explode("team",$Site_Admin);
					$my_spo_code = $my_s_arr[1];

					// 육상의 경우 하위 3종목을 선택 할 수 있어야 한다. //
					if($my_spo_code == "ATHIETICS")
					{
					?>
					<select name="spo_code" id='spo_codeSel' tabindex="2" hname="경기종목" required > <!--Sports_Sec_Code(this.form,1);Sports_Detail3(this.form,1)">-->
						<option value=''>--경기종목--</option>
						<?
						foreach($wp_sports_code as $keys => $values)
						{
							if($keys == $my_spo_code)
							{
								$is_selected = " selected ";
							}
							else
							{
								$is_selected = "";
							}

							if($keys == "ATHIETICS")
							{
								echo "<option value='$keys' $is_selected>$values - 전체</option>";
								echo "<option value='AS100' $is_selected>$values - 트랙</option>";
								echo "<option value='AS200' $is_selected>$values - 필드</option>";
							}
							else
							{
								continue;
							}
						}
						?>
					</select>
					<?
					}
					else
					{
					// 일반 종목인 경우 경기단체의 종목에 고정 된다. //
					?>
					<select name="spo_code" id='spo_codeSel' tabindex="2" hname="경기종목" required disabled > <!--Sports_Sec_Code(this.form,1);Sports_Detail3(this.form,1)">-->
						<option value=''>--경기종목--</option>
						<?
						foreach($wp_sports_code as $keys => $values)
						{
							if($keys == trim($my_spo_code))
							{
								$is_selected = " selected ";
							}
							else
							{
								$is_selected = "";
							}

							if($keys == "ATHIETICS")
							{
								echo "<option value='$keys' $is_selected>$values - 전체</option>";
								echo "<option value='AS100' $is_selected>$values - 트랙</option>";
								echo "<option value='AS200' $is_selected>$values - 필드</option>";
							}
							else
							{
								echo "<option value='$keys' $is_selected>$values</option>";
							}
						}
						?>
					</select>
					<input type="hidden" name="spo_code" value="<?=$my_spo_code?>">

					<?
					}
				 }
				 else
				 {
				?>
				<select name="spo_code" id='spo_codeSel' tabindex="2" hname="경기종목" required <?=$my_s_fixed?> > <!--Sports_Sec_Code(this.form,1);Sports_Detail3(this.form,1)">-->
					<option value=''>--경기종목--</option>
					<?
					foreach($wp_sports_code as $keys => $values)
					{
						if($keys == $my_spo_code)
						{
							$is_selected = " selected ";
						}
						else
						{
							$is_selected = "";
						}

						if($keys == "ATHIETICS" )
						{
							echo "<option value='$keys' $is_selected>$values - 전체</option>";
							echo "<option value='AS100' $is_selected>$values - 트랙</option>";
							echo "<option value='AS200' $is_selected>$values - 필드</option>";
						}
						else
						{
							echo "<option value='$keys' $is_selected>$values</option>";
						}
					}
					?>
				</select>
				<?
				}
				if($Admin_auth == "top" || $Admin_auth == "s_group") echo " | <input type='checkbox' name='prt_name' value='1' checked='checked'>이름출력";
				?>
				<input type="hidden" name="spo_code_name" value="" id='spo_code_name'>
                <input type="button" tabindex="4" value="미리보기" data-btn="preview" class="btnBox3">
                <input type="button" tabindex="5" value="종목별이벤트총계표 출력" data-btn="excel" class="btnBox3">
			</td>
		</tr>
		</table>
	</td>
</tr>
</table>
</form>

<link rel="stylesheet" href="wp_game_player.css">
<div style="max-width:1600px;overflow:auto">
<table class="table-type01" style="min-width:4100px">
	<thead>
		<tr>
			<th>종목</th>
			<th>등급</th>
			<th>성별</th>
			<th>세부</th>
			<th>시군</th>
			<th>총원</th>
			<th>이벤트</th>

            <?php
			foreach($wp_club_code as $keys => $vals){
				if($keys == "jnsad" || $keys == "WEBPLUS") continue;
				echo "<th>".substr($vals,0,4)."</th>";
				if($prt_name == "1") echo "<th>이름</th>";
			}
			?>
		</tr>
	</thead>
	<tbody>
        <?
		if(!$s_gam_uid) $s_gam_uid = $gam_uid;
		$where = " WHERE gam_uid = '$s_gam_uid'";
		//검색조건
		if($spo_code && $spo_code != "AS100" && $spo_code !="AS200")
		{
			$where .= " AND spo_code = '$spo_code'";
		}
		else
		{
			$where .= " AND spo_sec_code = '$spo_code'";
		}

		$query = "SELECT * FROM wp_game_event $where GROUP BY spo_code, tro_level_code, sex,spo_code_detail ORDER BY spo_code ASC, spo_sec_code ASC, tro_level_code ASC, sex ASC, spo_code_detail ASC";
		$result = mysql_query($query);
		while($obj = mysql_fetch_object($result)){
			$my_spo_code = $wp_game_code[$obj->spo_code];
			if($wp_sports_code[$obj->spo_code] != getSpo_sec_code($obj->spo_code,$obj->spo_sec_code)){
				$my_spo_code .= getSpo_sec_code($obj->spo_code,$obj->spo_sec_code);
			}

			$my_tro_code = substr($wp_trouble_code[$obj->tro_code],0,4);
			$my_tro_level_code = getTrouble_level_code($obj->spo_code, $obj->tro_level_code)."[$obj->tro_level_code] ";
			$my_sex = $wp_sex_code[$obj->sex]." ";
			$my_detail_code = $wp_sports_detail_code[$obj->spo_code_detail];

			/* 2017년 3월 10일 2차종목 미입력으로 주석처리 $a_que = "SELECT clu_code,group_concat(pla_name,sex_kind,group_str order by group_str asc separator ', ') pla_names,count(*) cnt FROM wp_game_player WHERE gam_uid = '$s_gam_uid' AND kubun='9' AND spo_code='$obj->spo_code' AND spo_sec_code='$obj->spo_sec_code' AND tro_level_code='$obj->tro_level_code' AND sex = '$obj->sex' AND spo_code_detail='$obj->spo_code_detail' GROUP BY clu_code ORDER BY clu_code ASC, pla_name ASC";*/

			$a_que = "SELECT clu_code,group_concat(pla_name,sex_kind,group_str order by group_str asc separator ', ') pla_names,count(*) cnt FROM wp_game_player WHERE gam_uid = '$s_gam_uid' AND kubun='9' AND spo_code='$obj->spo_code'  AND tro_level_code='$obj->tro_level_code' AND sex = '$obj->sex' AND spo_code_detail='$obj->spo_code_detail' GROUP BY clu_code ORDER BY clu_code ASC, pla_name ASC";

			//echo $a_que;
			$a_res = mysql_query($a_que);
			$club_cnt_arr = array();
			$tot_cnt = 0;
			$pla_name_arr = array();
			while($a_obj = mysql_fetch_object($a_res)){
				$club_cnt_arr[$a_obj->clu_code] = $a_obj->cnt;
				$pla_name_arr[$a_obj->clu_code] = $a_obj->pla_names;
				$tot_cnt += $a_obj->cnt;
			}
			unset($my_add);
			unset($font_color);
			if(count($club_cnt_arr) >=3){
				$my_add_flag = 1;
			} else {
				$my_add_flag = 0;
			}

			//단체전 경기일 경우 3개시군이상 각 시군별 2명 이상시 성립
			if($obj->spo_code == "BOWLING" && $obj->spo_code_detail == "BL102"){
				// 시군별 2명이 되어야 성립되던 조건을 삭제 2012. 04. 25.
				//if(count($club_cnt_arr) >= 3 && $tot_cnt == (count($club_cnt_arr) * 2)){
				if(count($club_cnt_arr) >= 3){
					$my_add_flag = 1;
				}
				else $my_add_flag = 0;
			}
			else if($obj->spo_code == "LAWNBOWIS" && $obj->spo_code_detail == "LB103"){
				foreach($wp_club_code as $keys => $vals){
					if($keys == "jnsad" || $keys == "WEBPLUS") continue;
					if($club_cnt_arr[$keys] % 2 != 0){
						$my_add_flag = 0; //성립되지 않음
						break;
					}
				} //foreach
			}
			else if($obj->spo_code == "TABLETENNIS" && $obj->spo_code_detail == "TT201"){
				foreach($wp_club_code as $keys => $vals){
					if($keys == "jnsad" || $keys == "WEBPLUS") continue;
					if($club_cnt_arr[$keys] > 0 && $club_cnt_arr[$keys] < 2 ){
						$my_add_flag = 0; //성립되지 않음
						break;
					}
				} //foreach
			}
			else if($obj->spo_code == "FOOTSAL"){
				foreach($wp_club_code as $keys => $vals){
					if($keys == "jnsad" || $keys == "WEBPLUS") continue;
					if($club_cnt_arr[$keys] > 0 && $club_cnt_arr[$keys] < 5 ){
						$my_add_flag = 0; //성립되지 않음
						break;
					}
				} //foreach
			}

			if($my_add_flag == 1){ //성립이면
				$my_add = "성립";
			}else{
				if(count($club_cnt_arr) > 0) $font_color = "style='color:#cc0000;font-weight:bold'";
			}

		echo "
		<tr>
			<td>$my_spo_code</td>
			<td nowrap>$my_tro_level_code</td>
			<td>$my_sex</td>
			<td nowrap>$my_detail_code</td>
			<td $font_color>".count($club_cnt_arr)."</td>
			<td>$tot_cnt</td>
			<td>$my_add</td>
		";
			foreach($wp_club_code as $keys => $vals){
				unset($font_color);
				if($keys == "jnsad" || $keys == "WEBPLUS") continue;

				if($obj->spo_code == "LAWNBOWIS" && $obj->spo_code_detail == "LB103"){
					if($club_cnt_arr[$keys] % 2 != 0){
						$font_color = "style='color:#cc0000;font-weight:bold'";
					}
				}else if($obj->spo_code == "GOALBALL"){
					if($club_cnt_arr[$keys] > 0 && $club_cnt_arr[$keys] < 3 ){
						$font_color = "style='color:#cc0000;font-weight:bold'";
					}
				}else if($obj->spo_code == "GATEBALL"){
					if($club_cnt_arr[$keys] > 0 && $club_cnt_arr[$keys] < 5 ){
						$font_color = "style='color:#cc0000;font-weight:bold'";
					}
				}else if($obj->spo_code == "DART"){
					if($club_cnt_arr[$keys] > 0 && $club_cnt_arr[$keys] < 5 ){
						$font_color = "style='color:#cc0000;font-weight:bold'";
					}
				}else if($obj->spo_code == "VOLLEYBALL"){
					if($club_cnt_arr[$keys] > 0 && $club_cnt_arr[$keys] < 6 ){
						$font_color = "style='color:#cc0000;font-weight:bold'";
					}
				}else if($obj->spo_code == "TABLETENNIS" && $obj->spo_code_detail == "TT201"){
					if($club_cnt_arr[$keys] > 0 && $club_cnt_arr[$keys] < 2 ){
						$font_color = "style='color:#cc0000;font-weight:bold'";
					}
				}else if($obj->spo_code == "FOOTSAL"){
					if($club_cnt_arr[$keys] > 0 && $club_cnt_arr[$keys] < 5 ){
						$font_color = "style='color:#cc0000;font-weight:bold'";
					}
				}else if($obj->spo_code == "BILLIARDS"){
					if($club_cnt_arr[$keys] > 0 && $club_cnt_arr[$keys] < 2 ){
						$font_color = "style='color:#cc0000;font-weight:bold'";
					}
				}else if($obj->spo_code == "SHUFFLEBOARD"){
					if($club_cnt_arr[$keys] > 0 && $club_cnt_arr[$keys] < 3 ){
						$font_color = "style='color:#cc0000;font-weight:bold'";
					}
				}else if($obj->spo_code == "CUROLLING"){
					if($club_cnt_arr[$keys] > 0 && $club_cnt_arr[$keys] < 3 ){
						$font_color = "style='color:#cc0000;font-weight:bold'";
					}
				}else if($obj->spo_code == "TARGET"){
					if($club_cnt_arr[$keys] > 0 && $club_cnt_arr[$keys] < 3 ){
						$font_color = "style='color:#cc0000;font-weight:bold'";
					}
				}else if($obj->spo_code == "HANDLER"){
					if($club_cnt_arr[$keys] % 2 != 0){
						$font_color = "style='color:#cc0000;font-weight:bold'";
					}
				}
				echo "<td $font_color>".$club_cnt_arr[$keys]."</td>";
				if($prt_name == "1") {

    				//종목별이벤트 총계표에서 남녀구분 2016.03.16
    				$patterns[0] = '/1/';
                    $patterns[1] = '/2/';
    				$patterns[2] = '/3/';
                    $patterns[3] = '/4/';
                    $replacements[0] = '<font color=\'blue\'>_M</font>';
                    $replacements[1] = '<font color=\'Green\'>_W</font>';
                    $replacements[2] = '<font color=\'blue\'>_M</font>';
                    $replacements[3] = '<font color=\'Green\'>_W</font>';

    				$pla_name0 =  preg_replace($patterns, $replacements, $pla_name_arr[$keys]);

    				//팀구분
    				$t_patterns[0] = '/A/';
                    $t_patterns[1] = '/B/';

                    $t_replacements[0] = '<font color=\'red\'> (A팀)</font>';
                    $t_replacements[1] = '<font color=\'red\'> (B팀)</font>';

    				$pla_name =  preg_replace($t_patterns, $t_replacements, $pla_name0);



    				echo "<td $font_color>".$pla_name.$group_str."</td>";
				}
			}
		echo "</tr>";
		 }
        ?>
	</tbody>
</table>
</div>
