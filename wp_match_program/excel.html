44<?
header("Content-type: application/vnd.ms-excel");
header("Content-Disposition: attachment; filename=종목별대진표.xls");
header("Content-Description: PHP4 Generated Data");

// Session 시작 //
session_start();

// Mysql 클래스 //
require_once "../wp_library/mysql_class.php";
// DB 생성 //
$Mysql = new Mysql;
// DB 연결 //
$Mysql->Connect();

// Setup 설정 //
require_once "../wp_library/setup.php";

// Paging 클래스 //
require_once "../wp_library/page_class.php";

// Error 함수 //
require_once "../wp_library/check.php";

?>
<body>
<?
if($s_game_code) {
	$game_code_arr = array();
	$game_code_arr[] = $s_game_code;
}else{
	if($spo_code){
		$game_code_arr = array();
		$g_que = "SELECT *, group_concat(tro_level_code order by tro_level_code ASC separator '/') tro_level_codes FROM wp_game_serial WHERE gam_uid='$s_gam_uid' AND spo_code = '$spo_code' GROUP BY game_code ORDER BY sort ASC";
		$g_res = mysql_query($g_que);
		while($g_obj = mysql_fetch_object($g_res)){
			$game_code_arr[] = $g_obj->game_code;
		}
	}
}
foreach($game_code_arr as $keys => $vals){

		$game_code = $vals;

		$s_que = "SELECT *, group_concat(spo_code_detail order by spo_code_detail ASC separator '/') spo_code_details FROM wp_game_serial WHERE gam_uid='$s_gam_uid' AND game_code = '$game_code' GROUP BY game_code";
		$s_res = mysql_query($s_que);
		$s_obj = mysql_fetch_object($s_res);
		$s_tmp = explode("/",$s_obj->spo_code_details);
		$my_spo_code_details = "'";
		foreach($s_tmp as $keys => $vals){
			$my_spo_code_details .= $vals."','";
		}
		$my_spo_code_details = substr($my_spo_code_details, 0 ,strlen($my_spo_code_details) - 2);
		//시범경기
		unset($my_test_game);
		if($s_obj->test_game == "1") $my_test_game = "<font color='#0000ff'>[시범경기]</font>";

		$where = " WHERE gam_uid='$s_gam_uid' AND spo_code='$s_obj->spo_code' AND spo_sec_code='$s_obj->spo_sec_code' AND sex='$s_obj->sex' AND tro_level_code = '$s_obj->tro_level_code' AND spo_code_detail in ($my_spo_code_details)";
		$oderby = " ORDER BY clu_code asc, spo_code ASC, spo_sec_code ASC, spo_code_detail ASC, tro_code ASC, sex ASC, tro_level_code ASC, pla_name ASC";

		//종목별 경기 인원 구하기
		$query = "SELECT *, group_concat(pla_name order by spo_code_detail ASC, pla_name ASC separator ',') players  FROM wp_game_player $where GROUP BY clu_code $orderby";
		$result = mysql_query($query);
		//$a_article = mysql_num_rows($result);
		$a_article = 1;

		//종목별 토너먼트 갯수 구하기
		if($spo_code == "LAWNBOWL"){
			if($s_obj->spo_sec_code == "LB100") { //개인전
				$tot_que = "SELECT * FROM wp_game_player $where GROUP BY clu_code,pla_id $orderby";
			}else if($s_obj->spo_sec_code == "LB200") { //단체전
				$tot_que = "SELECT * FROM wp_game_player $where GROUP BY clu_code, spo_code_detail $orderby";
			}
		}else if($spo_code == "BILLIARDS"){
			$tot_que = "SELECT *, group_concat(pla_name order by spo_code_detail ASC, pla_name ASC separator ',') players  FROM wp_game_player $where GROUP BY clu_code, spo_code_detail $orderby";
		}else if($spo_code == "BOCCIA" && $s_obj->spo_code_detail=="BC102"){ //보치아 단체전
			$tot_que = "SELECT * FROM wp_game_player $where GROUP BY clu_code, spo_code_detail $orderby";
		}else if($spo_code == "GOALBALL" || $spo_code == "VOLLEYBALL" || $spo_code == "GATEBALL" || $spo_code == "SHUFFLEBOARD" || $spo_code == "CUROLLING" || $spo_code == "TARGET" || $spo_code == "HANDLER"){ // 단체전
			$tot_que = "SELECT * FROM wp_game_player $where GROUP BY clu_code, spo_code_detail $orderby";
		}else if($spo_code == "TABLETENNIS"){
			if($s_obj->spo_sec_code == "TT100") { //개인전
				$tot_que = "SELECT * FROM wp_game_player $where GROUP BY clu_code,pla_id $orderby";
			}else if($s_obj->spo_sec_code == "TT200") { //단체전
				$tot_que = "SELECT * FROM wp_game_player $where GROUP BY clu_code, spo_code_detail $orderby";
			}
		}else{
			$tot_que = "SELECT *, group_concat(pla_name order by spo_code_detail ASC, pla_name ASC separator ',') players  FROM wp_game_player $where GROUP BY clu_code,pla_id $orderby";
		}
		$tot_res = mysql_query($tot_que);
		$player_cnt = mysql_num_rows($tot_res);

	?>
	<table width="750" cellpadding="0" cellspacing="0">
	<tr>
		<td style="padding-top:20px"><b><u>종목 : <?=$s_obj->game_name?> (<?=$player_cnt?>) <?=$my_test_game?></u></b></td>
	</tr>
	<tr>
		<td>
			<table border="1" width="750" cellpadding="3" cellspacing="1" bgcolor="#CACACA">
			<tr bgcolor="#FAFAFA">
				<td width="50px" align="center"><b>시/군</b></td>
				<td width="130px" align="center"><b>시/군명</b></td>
				<td align="center"><b>참가선수</b></td>
				<td width="50px" align="center"><b>인원</b></td>
			</tr>
			<?
			while($obj = mysql_fetch_object($result)){
				$my_player = $obj->players;
				$player_cnt = explode(",",$obj->players);
				echo "
				<tr bgcolor='#ffffff'>
					<td align='center'>$a_article</td>
					<td align='center'>".$wp_club_code[$obj->clu_code]."</td>
					<td>$my_player</td>
					<td align='center'>".count($player_cnt)."</td>
				</tr>
				";
				$a_article++;
			}
			?>
			</table>
		</td>
	</tr>
	<tr>
		<td height="20px"></td>
	</tr>
	<tr>
		<td>
			<?
			$tb_border="border='1'";
			$pe_que = "SELECT *, (SELECT sex FROM wp_player_ctrl WHERE wp_id=wgp.pla_id) p_sex FROM wp_game_player wgp $where $oderby";
			$pe_res = mysql_query($pe_que);
			$article_num = 1;//mysql_num_rows($pe_res);
			require "match_list_tonament.html";
			?>
		</td>
	</tr>
	</table>
	<br>
	<br>
	<br>
<?
} //while
?>
</body>
</html>