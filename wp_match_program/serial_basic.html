<?
if(!$s_gam_uid) $s_gam_uid = $gam_uid;
?>
<table class="table-global">
<tr>
	<form name="sForm" action="index.html?mode=<?=$mode?>" method="post" onSubmit="return validate(this)">
	<td>
		<!-- 선수 검색 시작 -->
		<table class="tbSearch-c">
		<tr>
			<th width="10%">대회선택</th>
			<td>
				<div style=" float:left">
				<select name="s_gam_uid" tabindex="1" hname="대회선택" required>
					<option value="">--선택-- </option>
					<?
						foreach($wp_games as $keys => $values){
							if($keys == $s_gam_uid)
								$is_selected = " selected";
							else $is_selected = "";
							echo "<option value='$keys' $is_selected>$values</option>";
						}
					?>
				</select>
				<select name="spo_code" tabindex="2" hname="경기종목" required onchange="Show_SecCode(this.form)">
					<option value=''>--경기종목--</option>
					<?
					foreach($wp_sports_code as $keys => $values){
						if($keys == $spo_code)
							$is_selected = " selected ";
						else $is_selected = "";
						echo "<option value='$keys' $is_selected>$values</option>";
					}
					?>
				</select>
				</div>
				<?
				// 육상이면
				if($spo_code == "ATHIETICS")
				{
					$is_display = "show";
				}
				else
				{
					$is_display = "none";
				}

				if($spo_sec_code == "AS100") $is_selected1 = " selected ";
				if($spo_sec_code == "AS200") $is_selected2 = " selected ";
				echo "
				<div id='secDiv' style=' float:left;display:$is_display'>
					<select name='spo_sec_code' hname='2차종목'>
						<option value=''>- 선택 -</option>
						<option value='AS100' $is_selected1>트랙</option>
						<option value='AS200' $is_selected2>필드</option>
					</select>
				</div>
				";
				?>
				<input type="submit" name="sch" tabindex="5" value="검색" class="btnBox3">
			</td>
		</tr>
		</table>
	</td>
	</form>
</tr>
<tr>
	<form name="signForm" action="serial_basic.php?gam_uid=<?=$s_gam_uid?>&spo_code=<?=$spo_code?>&spo_sec_code=<?=$spo_sec_code?>" method="post" onSubmit="return validate(this)">
	<td>
		<table class="tbList-a">
		<tr align="center">
			<th align="center"><b>게임번호</b></th>
			<th><b>종목</b></th>
			<th><b>등급</b></th>
			<th><b>성별</b></th>
			<th height="35"><b>세부</b></th>
			<th align="center"><b>시군</b></th>
			<th align="center">총원</th>
			<th align="center"><b>이벤트</b></th>
			<?
			foreach($wp_club_code as $keys => $vals){
				if($keys == "jnsad" || $keys == "WEBPLUS") continue;
				echo "<th width='30'>".substr($vals,0,4)."</th>";
				if($prt_name == "1") echo "<td width='30px'>이름</td>";
			}
			?>
		</tr>

		<?
		if(!$s_gam_uid) $s_gam_uid = $gam_uid;

		//검색조건
		$where = " WHERE gam_uid = '$s_gam_uid' AND spo_code = '$spo_code'";

		//2차종목코드가 있으면
		if($spo_sec_code) $where .= " AND spo_sec_code = '$spo_sec_code'";

		// 등록된 경기 쿼리
		$query = "SELECT wge.*, wgs.game_code,wgs.test_game, wgs.sort FROM (SELECT * FROM wp_game_event $where GROUP BY spo_code, tro_level_code, sex,spo_code_detail) wge LEFT JOIN (SELECT * FROM wp_game_serial $where) wgs ON wge.gam_uid = wgs.gam_uid AND wge.spo_code = wgs.spo_code AND wge.sex=wgs.sex AND wge.tro_level_code=wgs.tro_level_code AND wge.spo_code_detail=wgs.spo_code_detail ORDER BY wge.spo_code ASC, wge.spo_sec_code ASC, wge.tro_level_code ASC, wge.sex ASC, wge.spo_code_detail ASC";
		$result = mysql_query($query);
		$total_num = mysql_num_rows($result);
		$article_num = 1;
		while($obj = mysql_fetch_object($result)){
			$my_spo_code = $wp_game_code[$obj->spo_code];
			//echo $obj->spo_code;
			if($wp_sports_code[$obj->spo_code] != getSpo_sec_code($obj->spo_code,$obj->spo_sec_code)){
				$my_spo_code .= getSpo_sec_code($obj->spo_code,$obj->spo_sec_code);
			}

			$my_tro_code = substr($wp_trouble_code[$obj->tro_code],0,4);
			$my_tro_level_code = getTrouble_level_code($obj->spo_code, $obj->tro_level_code)."[$obj->tro_level_code]";
			$my_sex = $wp_sex_code[$obj->sex]." ";
			$my_detail_code = $wp_sports_detail_code[$obj->spo_code_detail];

			if($obj->spo_code == 'VOLLEYBALL') { //좌식배구일때 남_녀 모두 출력 2017.04.10
			
			 $a_que = "SELECT clu_code,group_concat(pla_name order by pla_name asc separator ',') pla_names,count(*) cnt FROM wp_game_player WHERE gam_uid = '$s_gam_uid' AND kubun='9' AND spo_code='$obj->spo_code' AND tro_level_code='$obj->tro_level_code' AND spo_code_detail='$obj->spo_code_detail' AND clu_code not in('jnsad','WEBPLUS') GROUP BY clu_code ORDER BY clu_code ASC, pla_name ASC";

             } else {

			 $a_que = "SELECT clu_code,group_concat(pla_name order by pla_name asc separator ',') pla_names,count(*) cnt FROM wp_game_player WHERE gam_uid = '$s_gam_uid' AND kubun='9' AND spo_code='$obj->spo_code' AND tro_level_code='$obj->tro_level_code' AND sex = '$obj->sex' AND spo_code_detail='$obj->spo_code_detail' AND clu_code not in('jnsad','WEBPLUS') GROUP BY clu_code ORDER BY clu_code ASC, pla_name ASC";

			 }


			$a_res = mysql_query($a_que);
			$club_cnt_arr = array();
			$tot_cnt = 0;
			$pla_name_arr = array();
			while($a_obj = mysql_fetch_object($a_res)){
				$club_cnt_arr[$a_obj->clu_code] = $a_obj->cnt;
				$pla_name_arr[$a_obj->clu_code] = $a_obj->pla_names;
				$tot_cnt += $a_obj->cnt;
			}
			unset($my_add);
			unset($font_color);
			unset($my_test_game);
			unset($test_checked);
			if(count($club_cnt_arr) >=3){
				$my_add_flag = 1;
			} else {
				$my_add_flag = 0;
			}

			//단체전 경기일 경우 3개시군이상 각 시군별 2명 이상시 성립
			if($obj->spo_code == "BOWLING" && $obj->spo_code_detail == "BL102"){
				if(count($club_cnt_arr) >= 3 && $tot_cnt == (count($club_cnt_arr) * 2)){
					$my_add_flag = 1;
				}
				else $my_add_flag = 0;
			}
			else if($obj->spo_code == "LAWNBOWL" && $obj->spo_code_detail == "LB103"){
				foreach($wp_club_code as $keys => $vals){
					if($club_cnt_arr[$keys] % 2 != 0){
						$my_add_flag = 0; //성립되지 않음
						break;
					}
				} //foreach
			}
			else if($obj->spo_code == "TABLETENNIS" && $obj->spo_code_detail == "TT201"){
				foreach($wp_club_code as $keys => $vals){
					if($club_cnt_arr[$keys] > 0 && $club_cnt_arr[$keys] < 2 ){
						$my_add_flag = 0; //성립되지 않음
						break;
					}
				} //foreach
			}
			else if($obj->spo_code == "FOOTSAL"){
				foreach($wp_club_code as $keys => $vals){
					if($club_cnt_arr[$keys] > 0 && $club_cnt_arr[$keys] < 5 ){
						$my_add_flag = 0; //성립되지 않음
						break;
					}
				} //foreach
			}
			// 수영 자유형의 25M이면 시범경기로 치른다.
			if($obj->spo_code == "SWIMMING" && $obj->spo_code_detail == "SG105" ){
				foreach($wp_club_code as $keys => $vals){
					if($club_cnt_arr[$keys] > 0){
						$my_add_flag = 1; //성립
						$my_test_game = "<br><input type='checkbox' name='test_game[]' value='$obj->spo_code/$obj->spo_sec_code/$obj->sex/$obj->tro_level_code/$obj->spo_code_detail' checked>시범경기";
						break;
					}
				} //foreach
			}
			if($my_add_flag == 1){ //성립이면
				$my_add = "<input type='checkbox' name='ok_match[]' value='$obj->spo_code/$obj->spo_sec_code/$obj->sex/$obj->tro_level_code/$obj->spo_code_detail' checked>성립";
			}else{
				if(count($club_cnt_arr) > 0) $font_color = "style='color:#cc0000;font-weight:bold'";
				$my_add = "<input type='checkbox' name='ok_match[]' value='$obj->spo_code/$obj->spo_sec_code/$obj->sex/$obj->tro_level_code/$obj->spo_code_detail'>성립";
				if($obj->test_game == "1") $test_checked = " checked"; // 시범경기로 치르면 체크한다.
				$my_test_game = "<br><input type='checkbox' name='test_game[]' value='$obj->spo_code/$obj->spo_sec_code/$obj->sex/$obj->tro_level_code/$obj->spo_code_detail' $test_checked>시범경기";
			}


/* Start 2016.05.09 참가시군이 없으면 출력 안되게 */

if(count($club_cnt_arr) == "") {  } else {


		echo "
		<tr>
			<td nowrap>
				<select name='$obj->spo_code/$obj->spo_sec_code/$obj->sex/$obj->tro_level_code/$obj->spo_code_detail'>
					<option value=''>- 선택 - </option>
		";

				for($i=1; $i<=$total_num; $i++){
					if($my_add_flag == 1){ // 경기가 성립하면
						if($i == $article_num) $choice = " selected";
						else $choice = "";
					}else{
						$choice = "";
					}
					$idx = str_pad($i,2,"0",STR_PAD_LEFT);
					echo "<option value='{$obj->spo_code}_{$obj->spo_sec_code}-{$idx}' $choice>{$obj->spo_code}_{$obj->spo_sec_code}-{$idx}</option>";
				}
		echo"
			</td>
			<td align='center' nowrap>$my_spo_code</td>
			<td nowrap nowrap>$my_tro_level_code</td>
			<td align='center' nowrap>$my_sex</td>
			<td nowrap>$my_detail_code</td>
			<td align='center' $font_color>".count($club_cnt_arr)."</td>
			<td align='center'>$tot_cnt</td>
			<td nowrap>$my_add $my_test_game</td>
		";
			foreach($wp_club_code as $keys => $vals){
				if($keys == "jnsad" || $keys == "WEBPLUS") continue;
				if($obj->spo_code == "LAWNBOWL" && $obj->spo_code_detail == "LB103"){
					if($club_cnt_arr[$keys] % 2 != 0){
						$font_color = "style='color:#cc0000;font-weight:bold'";
					}
				}else if($obj->spo_code == "TABLETENNIS" && $obj->spo_code_detail == "TT201"){
					if($club_cnt_arr[$keys] > 0 && $club_cnt_arr[$keys] < 2 ){
						$font_color = "style='color:#cc0000;font-weight:bold'";
					}
				}else if($obj->spo_code == "FOOTSAL"){
					if($club_cnt_arr[$keys] > 0 && $club_cnt_arr[$keys] < 5 ){
						$font_color = "style='color:#cc0000;font-weight:bold'";
					}
				}else if($obj->spo_code == "BILLIARDS"){
					if($club_cnt_arr[$keys] > 0 && $club_cnt_arr[$keys] < 2 ){
						$font_color = "style='color:#cc0000;font-weight:bold'";
					}
				}else if($obj->spo_code == "SHUFFLEBOARD"){
					if($club_cnt_arr[$keys] > 0 && $club_cnt_arr[$keys] < 3 ){
						$font_color = "style='color:#cc0000;font-weight:bold'";
					}
				}else if($obj->spo_code == "CUROLLING"){
					if($club_cnt_arr[$keys] > 0 && $club_cnt_arr[$keys] < 3 ){
						$font_color = "style='color:#cc0000;font-weight:bold'";
					}
				}else if($obj->spo_code == "TARGET"){
					if($club_cnt_arr[$keys] > 0 && $club_cnt_arr[$keys] < 3 ){
						$font_color = "style='color:#cc0000;font-weight:bold'";
					}
				}else if($obj->spo_code == "HANDLER"){
					if($club_cnt_arr[$keys] % 2 != 0){
						$font_color = "style='color:#cc0000;font-weight:bold'";
					}
				}
				echo "<td align='center' width='20px' $font_color>".$club_cnt_arr[$keys]."</td>";
				if($prt_name == "1") echo "<td nowrap $font_color>".$pla_name_arr[$keys]."</td>";
			}
		echo "
		</tr>";
			if($my_add_flag == 1){ //기초데이터 생성이면
				$article_num ++;
			}
		 }


   } /* End 2016.05.09 참가시군이 없으면 출력 안되게 */

		 ?>
		</table>
	</td>
</tr>
<tr>
	<td style="padding-top:10px" align="center"><input type="submit" name="add" tabindex="5" value="기초데이터생성" class="btnBox3" style="width:150px;height:30px;font-size:12pt"></td>
</tr>
</table>
</form>
